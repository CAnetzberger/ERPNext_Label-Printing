{"version":3,"file":"label_printing.min.js","sources":["../../../../apps/label_printing/label_printing/public/js/label_printing_desk.js"],"sourcesContent":["$(document).ready(function () {\n  $(\".dropdown-notifications\").after('<li id=\"labels-toolbar\" class=\"nav-item\"><a class=\"nav-link label-printing-icon text-muted\"><i class=\"fa fa-tag fa-lg\" aria-hidden=\"true\"></i></a></li>');\n  $(\"#labels-toolbar\").click(function (page) {\n    setupLabelsDialog(page);\n  });\n\n});\n\n\n\nfunction setupLabelsDialog(page) {\n  let cur_frm = page.view.cur_frm\n\n  let fields = {\n    doctype: '',\n    docname: '',\n    item_code: '',\n    item_name: '',\n    delivery_date: '',\n    customer: '',\n    batch: '',\n    information: '',\n    total_amount: 0,\n    labels: [{\n      item_qty: 0,\n      label_qty: 0,\n    }]\n  };\n\n\n  if (cur_frm !== null) {\n    if (cur_frm.doctype === \"Work Order\" || cur_frm.doctype === \"Item\") {\n      if (cur_frm.docname) {\n        fields.doctype = cur_frm.doctype\n        fields.docname = cur_frm.docname\n      }\n    }\n  }\n\n  let d = new frappe.ui.Dialog({\n    title: __(\"Print Labels\"),\n    fields: [{\n      label: __(\"Reference Doctype\"),\n      options: ['Work Order', 'Item'],\n      fieldname: 'doctype',\n      fieldtype: 'Select',\n      default: fields.doctype,\n    },\n    {\n      label: __(\"Get data\"),\n      fieldname: 'get_data',\n      fieldtype: 'Button',\n      click: () => {\n        handleDataFetch()\n      }\n    },\n    {\n      fieldtype: 'Column Break'\n    },\n    {\n      label: __(\"Reference Docname\"),\n      fieldname: 'docname',\n      fieldtype: 'Data',\n      options: 'doctype',\n      default: fields.docname,\n    },\n    {\n      fieldtype: 'Section Break',\n      label: __('Information')\n    },\n    {\n      label: __(\"Item Code\"),\n      fieldname: 'item_code',\n      fieldtype: 'Data'\n    },\n    {\n      label: __(\"Item Name\"),\n      fieldname: 'item_name',\n      fieldtype: 'Data'\n    },\n    {\n      label: __(\"Delivery Date\"),\n      fieldname: 'delivery_date',\n      fieldtype: 'Date'\n    },\n    {\n      fieldtype: 'Column Break'\n    },\n    {\n      label: __(\"Customer\"),\n      fieldname: 'customer',\n      fieldtype: 'Data'\n    },\n    {\n      label: __(\"Batch\"),\n      fieldname: 'batch',\n      fieldtype: 'Data'\n    },\n    {\n      fieldtype: 'Section Break',\n      label: __('Labels')\n    },\n    {\n      fieldname: \"labels\",\n      fieldtype: \"Table\",\n      cannot_add_rows: false,\n      in_place_edit: true,\n      data: fields.labels,\n      get_data: () => {\n        return fields.labels;\n      },\n      fields: [{\n        fieldtype: 'Int',\n        fieldname: \"item_qty\",\n        in_list_view: 1,\n        label: __('Item Qty')\n      },\n      {\n        label: __(\"Label Qty\"),\n        fieldname: 'label_qty',\n        in_list_view: 1,\n        fieldtype: 'Int'\n      },\n      ]\n    },\n    ],\n    primary_action_label: 'Print',\n    primary_action(values) {\n      fields = values\n\n      frappe.call({\n        method: \"label_printing.api.print_label\",\n        args: {\n          values: fields\n        },\n        callback: function (r) {\n          if (r.message === 200) {\n            frappe.show_alert(\"Label printing successful\", 5);\n          }\n        },\n      });\n\n      d.hide();\n    }\n  });\n  handleDataFetch();\n  d.show();\n\n\n  // handle dpctype change\n  d.fields_dict.doctype.$input.on('change', function () {\n    d.fields_dict.docname.refresh();\n  });\n\n  function handleDataFetch() {\n    fields = d.get_values()\n    if (fields.doctype && fields.docname) {\n      let doc = get_doc(fields.doctype, fields.docname)\n      if (fields.doctype === \"Work Order\") {\n        let item = get_doc(\"Item\", doc.production_item)\n        let se = 1\n        frappe.call({\n          method: \"label_printing.api.get_associated_stockentry\",\n          async: false,\n          args: { workorder: fields.docname },\n          callback(r) {\n            if (r.message) {\n              fields.batch = r.message.items[r.message.items.length - 1].batch_no\n            }\n          }\n        })\n        fields.item_code = item.item_code\n        fields.item_name = item.item_name\n        fields.delivery_date = doc.expected_delivery_date\n        fields.labels[0].item_qty = doc.qty\n        fields.labels[0].label_qty = 1\n\n        if (item.associated_company) {\n          let customer = get_doc(\"Customer\", item.associated_company)\n          if (customer.short_name) {\n            fields.customer = customer.short_name\n          } else {\n            fields.customer = item.associated_company\n          }\n        }\n\n        fields.total_amount = doc.qty\n        fields.labels[0].qty_per_label = doc.qty\n        d.fields_dict.labels.refresh();\n\n      } else if (fields.doctype === \"Item\") {\n        let item = get_doc(\"Item\", doc.item_code)\n\n        fields.item_code = doc.item_code\n        fields.item_name = doc.item_name\n\n        if (item.associated_company) {\n          let customer = get_doc(\"Customer\", doc.associated_company)\n          if (customer.short_name) {\n            fields.customer = customer.short_name\n          } else {\n            fields.customer = doc.associated_company\n          }\n        }\n      }\n\n      d.set_values(fields)\n    }\n  }\n\n}\n\nfunction get_doc(doctype, docname) {\n  let res;\n  frappe.call({\n    method: \"frappe.client.get\",\n    async: false,\n    args: {\n      doctype: doctype,\n      name: docname,\n    },\n    callback(r) {\n      if (r.message) {\n        res = r.message\n      }\n    }\n  });\n  return res;\n}"],"names":["get_doc","doctype","docname","let","res","frappe","call","method","async","args","name","callback","r","message","$","document","ready","after","click","page","cur_frm","view","fields","item_code","item_name","delivery_date","customer","batch","information","total_amount","labels","item_qty","label_qty","d","ui","Dialog","title","__","label","options","fieldname","fieldtype","default","handleDataFetch","cannot_add_rows","in_place_edit","data","get_data","in_list_view","primary_action_label","primary_action","values","show_alert","hide","get_values","doc","item","production_item","workorder","items","length","batch_no","expected_delivery_date","qty","associated_company","short_name","qty_per_label","fields_dict","refresh","set_values","show","$input","on","setupLabelsDialog"],"mappings":"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"}